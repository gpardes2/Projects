#! /bin/bash

set -e

# Function to Check and Create Log Analytics Workspace
check_and_create_log_analytics_workspace() {
    local resource_group=$RESOURCE_GROUP
    local workspace_name=$LOG_ANALYTICS_WORKSPACE_NAME
    local location=$LOCATION

    logger "INFO" "Checking if Log Analytics Workspace: $workspace_name exists in Resource Group: $resource_group..."

    # Check if Log Analytics Workspace exists
    local workspace_exists=$(az monitor log-analytics workspace show \
        --resource-group "$resource_group" \
        --workspace-name "$workspace_name" \
        --query "name" \
        --output tsv 2>/dev/null)

    if [ "$workspace_exists" == "$workspace_name" ]; then
        logger "INFO" "Log Analytics Workspace: $workspace_name already exists."
        return 0
    fi

    logger "INFO" "Log Analytics Workspace: $workspace_name does not exist. Creating..."

    # Create Log Analytics Workspace
    az monitor log-analytics workspace create \
        --resource-group "$resource_group" \
        --workspace-name "$workspace_name" \
        --location "$location"

    if [ $? -ne 0 ]; then
        logger "ERROR" "Failed to create Log Analytics Workspace: $workspace_name"
        return 1
    fi

    logger "INFO" "Log Analytics Workspace: $workspace_name created successfully."
    return 0
}
